{
	email {$CADDY_EMAIL}
}

{$DEMO_DOMAIN} {
	encode zstd gzip

	# Optional legacy frontend route.
	handle_path /app* {
		root * /srv/frontend
		try_files {path} /index.html
		file_server
	}

	# Optional protection for admin and debug routes:
	# 1) Generate a hash: docker run --rm caddy:2.9-alpine caddy hash-password --plaintext "CHANGE_ME"
	# 2) Set BASIC_AUTH_USER and BASIC_AUTH_PASSWORD_HASH in .env.prod
	# 3) Uncomment the block below
	#
	# @protected path /admin* /debug/*
	# basicauth @protected {
	#	{$BASIC_AUTH_USER} {$BASIC_AUTH_PASSWORD_HASH}
	# }

	@backend path /api/* /healthz /health /admin* /debug/* /demo* /experts/*
	handle @backend {
		reverse_proxy web:8000
	}

	handle_path /static/* {
		root * /srv/static
		file_server
	}

	# Lovable/Vite builds use root-relative assets.
	@frontend_assets path /assets/* /favicon.ico /robots.txt /manifest.json /site.webmanifest /placeholder.svg /stitch-screens/*
	handle @frontend_assets {
		root * /srv/frontend
		file_server
	}

	header {
		-Server
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=()"
	}

	# Default route: serve frontend directly on root domain.
	handle {
		root * /srv/frontend
		try_files {path} /index.html
		file_server
	}
}
