{
	email {$CADDY_EMAIL}
}

{$DEMO_DOMAIN} {
	encode zstd gzip

	# Optional protection for admin and debug routes:
	# 1) Generate a hash: docker run --rm caddy:2.9-alpine caddy hash-password --plaintext "CHANGE_ME"
	# 2) Set BASIC_AUTH_USER and BASIC_AUTH_PASSWORD_HASH in .env.prod
	# 3) Uncomment the block below
	#
	# @protected path /admin* /debug/*
	# basicauth @protected {
	#	{$BASIC_AUTH_USER} {$BASIC_AUTH_PASSWORD_HASH}
	# }

	@backend path /api/* /healthz /health /admin* /debug* /demo* /experts/*
	handle @backend {
		reverse_proxy web:8000
	}

	# Backup route to old Django UI.
	@legacy path /legacy /legacy/*
	handle @legacy {
		redir /demo/ 302
	}

	handle_path /static/* {
		root * /srv/static
		file_server
	}

	# Lovable/Vite builds use root-relative assets.
	@frontend_assets path /assets/* /favicon.ico /robots.txt /manifest.json /site.webmanifest /placeholder.svg /stitch-screens/*
	handle @frontend_assets {
		root * /srv/frontend
		file_server
	}

	header {
		-Server
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=()"
	}

	# Stitch page routes.
	@stitch_root path /
	handle @stitch_root {
		root * /srv/frontend
		rewrite * /stitch-screens/screen-01/code.html
		file_server
	}

	@stitch_papers path /papers /papers/*
	handle @stitch_papers {
		root * /srv/frontend
		rewrite * /stitch-screens/screen-02/code.html
		file_server
	}

	@stitch_experts path /experts /experts/*
	handle @stitch_experts {
		root * /srv/frontend
		rewrite * /stitch-screens/screen-03/code.html
		file_server
	}

	@stitch_graph path /graph /graph/*
	handle @stitch_graph {
		root * /srv/frontend
		rewrite * /stitch-screens/screen-04/code.html
		file_server
	}

	@stitch_ask path /ask /ask/* /states /states/*
	handle @stitch_ask {
		root * /srv/frontend
		rewrite * /stitch-screens/screen-06/code.html
		file_server
	}

	# Fallback: default to Stitch landing.
	handle {
		root * /srv/frontend
		try_files {path} /stitch-screens/screen-01/code.html
		file_server
	}
}
